# KTWIN - Kubernetes-based Platform for Digital Twins

KTWIN is a Kubernetes-native platform that provides abstractions to Digital Twin Product Owners and Operators to facilitate the specification, deployment and operations of Digital Twin systems.

KTWIN provides mechanisms for processing events generated by real-world devices and store them for later analysis. Real-world entities are defined as Real Twin while its virtual counterpart is defined as Virtual Twin. KTWIN allows to Digital Twin Owners to define their Digital Twin using ontology-based languages and it automatically maps twin entities to Kubernetes resources, such as containers.

## Event Messaging

KTWIN events can be classified as internal and external events.

- Internal Events: events generated by Virtual Twins that are propagated to other Virtual Twins or to some internal system, such as an Event Store.
- External Events: events exchanged between Real and Virtual Twins.

## Internal Events

Internal events are exchanged using Cloud Event specification and uses both HTTP and AMQP protocols. From the user container perspective, the communication uses HTTP, and the platform uses AMQP for efficient routing and scalability.

```json
{
    "id": "41c9afea-02a1-48a0-ad3c-cb9faae86551",
    "type" : "ktwin.real.virtual.generated",
    "source": "ktwin.real.<instanceId>",
    "time" : "2018-04-05T17:31:00Z",
    "datacontenttype": "application/json",
    "data": {
        "temperature": 20
    }
}
```

### External Events

KTWIN allows devices to publish events using MQTT, AMQP and HTTP protocols.

#### MQTT

The MQTT messages are converted to AMQP by the broker (RabbitMQ has MQTT-AMQP protocol interoperability). All MQTT messages are published to the `amq.topic` which is a RabbitMQ exchange. The MQTT topic name is converted the RabbitMQ `routingKey` which is used by internal routing rules to define to what service that event must be sent.

#### AMQP and HTTP

AMQP and HTTP messages uses Cloud Event spec.

### MQTT-AMQP Protocol Interoperability

RabbitMQ offers MQTT-AMQP protocol interoperability. KTWIN offers dispatchers that convert the messages from routing keys to headers topic.

#### Real Twin publisher

Pattern: `ktwin/real/twin-interface/twin-instance`

Examples:

- `ktwin/real/pole-01`
- `ktwin/real/weather-sensor-01`

#### Real Twin subscriber

Real Twin subscriber topics:

Pattern: `ktwin/virtual/twin-instance`

Examples:

- `ktwin/virtual/pole-01`
- `ktwin/virtual/weather-sensor-01`


### Cloud Event Headers

The KTWIN dispatchers convert the AMQP-routing key event to a AMQP-header event.

#### AMQP Routing Key -> AMQP Header (Real -> Virtual communication)

##### MQTT Topic for Publishers

```
mqtt-topic: ktwin/real/pole/pole-01
message: { "from": "real" }
```

##### AMQP with Routing Key

```
routingKey: ktwin.real.pole.pole-01
message: { "from": "real" }
```

##### AMQP with Headers

```
headers:
    - source: pole-01
    - type: ktwin.real.pole
message: { "from": "real" }
```

#### AMQP Header -> AMQP Routing Key (Virtual -> Real communication)

##### AMQP with Headers

```
headers:
    - source: pole-02
    - type: ktwin.virtual.pole
message: { "from": "virtual" }
```

##### MQTT Topic for Subscribers

```
routingKey: ktwin.real.pole.pole-02
message: { "from": "virtual" }
```

##### AMQP with Routing Key

```
mqtt-topic: ktwin/real/pole/pole-02
message: { "from": "virtual" }
```

## Event Types mapping

| Event Type  | Source | Target | |
| ----------- | ----------- | ----------- | ----------- |
| `ktwin.real.<twin-instance>.generated`    | Real Twin     | Virtual Twin + Event Store | Event generated by a Real Twin and sent to Virtual Twin. It can be stored in Event Store. |
| `ktwin.virtual.<twin-instance>.generated`    | Virtual Twin  | Real Twin or Virtual Twin + Event Store | Event generated by Virtual Twin and sent to a Real Twin or other Virtual Twin. It can be stored in Event Store. |
